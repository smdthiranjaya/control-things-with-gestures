<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesture Control Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.36/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.5.0/dist/socket.io.min.js"></script>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
  </head>
  <body>
    <div
      id="app"
      :class="['min-h-screen', darkMode ? 'bg-gray-900' : 'bg-gray-50']"
    >
      <div
        v-if="backendRestarting"
        class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"
      >
        <div
          class="bg-white dark:bg-gray-800 rounded-lg p-8 text-center max-w-md"
        >
          <div
            class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 mx-auto mb-4"
          ></div>
          <h3
            class="text-xl font-semibold mb-2"
            :class="darkMode ? 'text-white' : 'text-gray-900'"
          >
            Restarting Backend...
          </h3>
          <p :class="darkMode ? 'text-gray-400' : 'text-gray-600'">
            Applying new network settings. Please wait...
          </p>
          <p
            class="mt-2 text-sm"
            :class="darkMode ? 'text-gray-500' : 'text-gray-400'"
          >
            This will take about 5-10 seconds
          </p>
        </div>
      </div>

      <div class="container mx-auto px-4 py-8">
        <header class="mb-8 relative">
          <div class="text-center">
            <h1
              :class="['text-3xl font-bold', darkMode ? 'text-indigo-400' : 'text-indigo-600']"
            >
              Gesture Control Dashboard
            </h1>
            <p :class="darkMode ? 'text-gray-400' : 'text-gray-600'">
              Control smart devices with hand gestures through computer vision
            </p>
          </div>
          <button
            @click="toggleDarkMode"
            :class="['absolute top-0 right-0 p-3 rounded-lg transition-colors', darkMode ? 'bg-gray-800 hover:bg-gray-700 text-yellow-400' : 'bg-white hover:bg-gray-100 text-gray-700 shadow-md']"
          >
            <span class="material-icons"
              >{{ darkMode ? 'light_mode' : 'dark_mode' }}</span
            >
          </button>
        </header>

        <div
          :class="['rounded-lg shadow-lg p-6 mb-6', darkMode ? 'bg-gray-800' : 'bg-white']"
        >
          <h2
            :class="['text-xl font-semibold mb-4', darkMode ? 'text-white' : 'text-gray-900']"
          >
            Device Control
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div
              v-for="(status, device) in deviceStatus"
              :key="device"
              :class="['p-4 border rounded-lg transition-colors', 
                darkMode 
                  ? (status === 'ON' ? 'border-indigo-500 bg-gray-700' : 'border-gray-600 bg-gray-750')
                  : (status === 'ON' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300')]"
            >
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                  <span
                    class="material-icons mr-2"
                    :class="status === 'ON' ? 'text-indigo-500' : (darkMode ? 'text-gray-500' : 'text-gray-400')"
                  >
                    {{ getDeviceIcon(device) }}
                  </span>
                  <span
                    :class="['font-medium', darkMode ? 'text-white' : 'text-gray-900']"
                    >{{ getDeviceDisplayName(device) }}</span
                  >
                </div>
                <label class="switch">
                  <input
                    type="checkbox"
                    :checked="status === 'ON'"
                    @change="toggleDevice(device, $event.target.checked)"
                  />
                  <span class="slider round"></span>
                </label>
              </div>
              <div class="flex mt-2">
                <button
                  @click="controlDevice(device, 'on')"
                  :class="['flex-1 py-1 mr-1 rounded font-medium transition-colors', 
                    status === 'ON' 
                      ? 'bg-indigo-600 text-white' 
                      : (darkMode ? 'bg-gray-600 text-gray-300 hover:bg-gray-500' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')]"
                >
                  ON
                </button>
                <button
                  @click="controlDevice(device, 'off')"
                  :class="['flex-1 py-1 ml-1 rounded font-medium transition-colors', 
                    status === 'OFF' 
                      ? 'bg-red-500 text-white' 
                      : (darkMode ? 'bg-gray-600 text-gray-300 hover:bg-gray-500' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')]"
                >
                  OFF
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:items-stretch">
          <div class="lg:col-span-3 flex flex-col">
            <div
              :class="['rounded-lg shadow-lg p-6 w-full flex-1', darkMode ? 'bg-gray-800' : 'bg-white']"
            >
              <h2
                :class="['text-xl font-semibold mb-4', darkMode ? 'text-white' : 'text-gray-900']"
              >
                Settings
              </h2>

              <div
                :class="['mb-6 pb-4 border-b', darkMode ? 'border-gray-700' : 'border-gray-200']"
              >
                <h3
                  :class="['text-lg font-medium mb-3', darkMode ? 'text-gray-200' : 'text-gray-800']"
                >
                  Camera Settings
                </h3>

                <div class="mb-4">
                  <label
                    :class="['block mb-2', darkMode ? 'text-gray-300' : 'text-gray-700']"
                    >Camera Source</label
                  >
                  <select
                    v-model="settings.camera_source"
                    @change="updateSettings"
                    :class="['w-full rounded px-3 py-2', darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border border-gray-300']"
                  >
                    <option
                      v-for="(value, key) in cameras"
                      :key="key"
                      :value="key"
                    >
                      {{ key }}
                    </option>
                  </select>
                </div>

                <div class="flex items-center">
                  <input
                    type="checkbox"
                    id="show-landmarks"
                    v-model="settings.show_landmarks"
                    @change="updateSettings"
                    class="mr-2 h-5 w-5 text-indigo-600"
                  />
                  <label
                    for="show-landmarks"
                    :class="darkMode ? 'text-gray-300' : 'text-gray-700'"
                    >Show Hand Landmarks</label
                  >
                </div>
              </div>

              <div :class="['mb-6', darkMode ? '' : '']">
                <h3
                  :class="['text-lg font-medium mb-3', darkMode ? 'text-gray-200' : 'text-gray-800']"
                >
                  Device Detection Settings
                </h3>

                <div class="mb-3 flex items-center">
                  <input
                    type="checkbox"
                    id="detect-all-leds"
                    v-model="settings.detect_all_leds"
                    @change="updateSettings"
                    class="mr-2 h-5 w-5 text-indigo-600"
                  />
                  <label
                    for="detect-all-leds"
                    :class="darkMode ? 'text-gray-300' : 'text-gray-700'"
                    >Detect All LEDs</label
                  >
                </div>

                <div
                  :class="['border-t my-3 pt-3', darkMode ? 'border-gray-700' : 'border-gray-200']"
                ></div>

                <div class="mb-3 flex items-center">
                  <input
                    type="checkbox"
                    id="detect-led1"
                    v-model="settings.detect_led1"
                    @change="updateSettings"
                    class="mr-2 h-5 w-5 text-indigo-600"
                  />
                  <label
                    for="detect-led1"
                    :class="darkMode ? 'text-gray-300' : 'text-gray-700'"
                    >Detect Red LED</label
                  >
                </div>

                <div class="mb-3 flex items-center">
                  <input
                    type="checkbox"
                    id="detect-led2"
                    v-model="settings.detect_led2"
                    @change="updateSettings"
                    class="mr-2 h-5 w-5 text-indigo-600"
                  />
                  <label
                    for="detect-led2"
                    :class="darkMode ? 'text-gray-300' : 'text-gray-700'"
                    >Detect Green LED</label
                  >
                </div>

                <div class="flex items-center">
                  <input
                    type="checkbox"
                    id="detect-motor"
                    v-model="settings.detect_motor"
                    @change="updateSettings"
                    class="mr-2 h-5 w-5 text-indigo-600"
                  />
                  <label
                    for="detect-motor"
                    :class="darkMode ? 'text-gray-300' : 'text-gray-700'"
                    >Detect Motor & Buzzer</label
                  >
                </div>
              </div>

              <div class="mt-6 text-center">
                <button
                  @click="saveSettings"
                  :class="['font-medium py-2 px-6 rounded-md', darkMode ? 'bg-indigo-500 hover:bg-indigo-600 text-white' : 'bg-indigo-600 hover:bg-indigo-700 text-white']"
                >
                  Save Settings
                </button>
              </div>
            </div>
          </div>

          <div class="lg:col-span-6 flex flex-col">
            <div
              :class="['rounded-lg shadow-lg p-6 w-full flex-1', darkMode ? 'bg-gray-800' : 'bg-white']"
            >
              <h2
                :class="['text-xl font-semibold mb-4', darkMode ? 'text-white' : 'text-gray-900']"
              >
                Camera Feed
              </h2>
              <div class="relative">
                <div
                  v-if="loading"
                  class="bg-gray-900 rounded-lg h-96 flex items-center justify-center"
                >
                  <div class="text-center">
                    <div
                      class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mx-auto mb-4"
                    ></div>
                    <p class="text-white">Loading camera feed...</p>
                  </div>
                </div>
                <div
                  v-else-if="!settings.camera_source"
                  class="bg-gray-900 rounded-lg h-96 flex items-center justify-center"
                >
                  <div class="text-center">
                    <span class="material-icons text-5xl text-white mb-2"
                      >videocam_off</span
                    >
                    <p class="text-white">No camera source selected</p>
                  </div>
                </div>
                <div v-else class="rounded-lg overflow-hidden">
                  <img
                    :src="videoFeedUrl"
                    alt="Camera Feed"
                    class="w-full h-auto max-h-[600px] object-contain"
                  />
                  <div
                    class="absolute bottom-4 left-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded"
                  >
                    {{ settings.gesture_detection_enabled ? 'Gesture Detection:                    ON' : 'Gesture Detection: OFF' }}
                  </div>
                  <div
                    class="absolute top-4 right-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded"
                  >
                    Source: {{ settings.camera_source }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="lg:col-span-3 flex flex-col">
            <div
              :class="['rounded-lg shadow-lg p-6 w-full flex-1', darkMode ? 'bg-gray-800' : 'bg-white']"
            >
              <h2
                :class="['text-xl font-semibold mb-4', darkMode ? 'text-white' : 'text-gray-900']"
              >
                Network Configuration
              </h2>

              <div class="space-y-6">
                <div
                  :class="['rounded-lg p-4', darkMode ? 'border border-gray-700' : 'border border-gray-300']"
                >
                  <h3
                    :class="['text-lg font-medium mb-3 flex items-center', darkMode ? 'text-gray-200' : 'text-gray-800']"
                  >
                    <span class="material-icons mr-2 text-blue-600"
                      >videocam</span
                    >
                    ESP32-CAM
                  </h3>

                  <div class="mb-4">
                    <label
                      :class="['block mb-2', darkMode ? 'text-gray-300' : 'text-gray-700']"
                      >Camera Stream URL</label
                    >
                    <input
                      type="text"
                      v-model="settings.esp32_cam_url"
                      :class="['w-full rounded px-3 py-2', darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border border-gray-300']"
                      placeholder="http://10.168.182.148:81/stream"
                    />
                  </div>
                </div>

                <div
                  :class="['rounded-lg p-4', darkMode ? 'border border-gray-700' : 'border border-gray-300']"
                >
                  <h3
                    :class="['text-lg font-medium mb-3 flex items-center', darkMode ? 'text-gray-200' : 'text-gray-800']"
                  >
                    <span class="material-icons mr-2 text-green-600"
                      >memory</span
                    >
                    ESP8266 (IoT)
                  </h3>

                  <div class="mb-4">
                    <label
                      :class="['block mb-2', darkMode ? 'text-gray-300' : 'text-gray-700']"
                      >Device IP Address</label
                    >
                    <input
                      type="text"
                      v-model="settings.esp8266_ip"
                      :class="['w-full rounded px-3 py-2', darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'border border-gray-300']"
                      placeholder="192.168.1.15"
                    />
                  </div>
                </div>
              </div>

              <div class="mt-6 text-center">
                <button
                  @click="saveNetworkSettings"
                  :class="['font-medium py-2 px-6 rounded-md', darkMode ? 'bg-indigo-500 hover:bg-indigo-600 text-white' : 'bg-indigo-600 hover:bg-indigo-700 text-white']"
                >
                  Save Network Settings
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <div
            :class="['rounded-lg shadow-lg p-6', darkMode ? 'bg-gray-800' : 'bg-white']"
          >
            <h2
              :class="['text-xl font-semibold mb-4', darkMode ? 'text-white' : 'text-gray-900']"
            >
              Gesture Instructions
            </h2>
            <div class="overflow-x-auto">
              <table
                :class="['min-w-full', darkMode ? 'text-gray-300' : 'text-gray-900']"
              >
                <thead :class="darkMode ? 'bg-gray-700' : 'bg-gray-50'">
                  <tr>
                    <th
                      :class="['px-6 py-3 text-left text-xs font-medium uppercase tracking-wider', darkMode ? 'text-gray-300' : 'text-gray-500']"
                    >
                      Gesture
                    </th>
                    <th
                      :class="['px-6 py-3 text-left text-xs font-medium uppercase tracking-wider', darkMode ? 'text-gray-300' : 'text-gray-500']"
                    >
                      Action
                    </th>
                  </tr>
                </thead>
                <tbody
                  :class="['divide-y', darkMode ? 'divide-gray-700' : 'divide-gray-200']"
                >
                  <tr>
                    <td
                      :class="['px-6 py-4 whitespace-nowrap', darkMode ? 'text-gray-300' : 'text-gray-900']"
                    >
                      0 Fingers (Fist)
                    </td>
                    <td
                      :class="['px-6 py-4', darkMode ? 'text-gray-400' : 'text-gray-500']"
                    >
                      Turn OFF all devices (Red LED, Green LED, Motor & Buzzer)
                    </td>
                  </tr>
                  <tr>
                    <td
                      :class="['px-6 py-4 whitespace-nowrap', darkMode ? 'text-gray-300' : 'text-gray-900']"
                    >
                      1 Finger
                    </td>
                    <td
                      :class="['px-6 py-4', darkMode ? 'text-gray-400' : 'text-gray-500']"
                    >
                      Toggle Red LED (ON/OFF)
                    </td>
                  </tr>
                  <tr>
                    <td
                      :class="['px-6 py-4 whitespace-nowrap', darkMode ? 'text-gray-300' : 'text-gray-900']"
                    >
                      2 Fingers
                    </td>
                    <td
                      :class="['px-6 py-4', darkMode ? 'text-gray-400' : 'text-gray-500']"
                    >
                      Toggle Green LED (ON/OFF)
                    </td>
                  </tr>
                  <tr>
                    <td
                      :class="['px-6 py-4 whitespace-nowrap', darkMode ? 'text-gray-300' : 'text-gray-900']"
                    >
                      3 Fingers
                    </td>
                    <td
                      :class="['px-6 py-4', darkMode ? 'text-gray-400' : 'text-gray-500']"
                    >
                      Turn ON Motor & Buzzer (automatically turns OFF when
                      gesture changes)
                    </td>
                  </tr>
                  <tr>
                    <td
                      :class="['px-6 py-4 whitespace-nowrap', darkMode ? 'text-gray-300' : 'text-gray-900']"
                    >
                      5 Fingers (Open Hand)
                    </td>
                    <td
                      :class="['px-6 py-4', darkMode ? 'text-gray-400' : 'text-gray-500']"
                    >
                      Turn ON Red LED and Green LED (motor stays OFF)
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <style>
      .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: 0.4s;
        transition: 0.4s;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        -webkit-transition: 0.4s;
        transition: 0.4s;
      }

      input:checked + .slider {
        background-color: #6366f1;
      }

      input:focus + .slider {
        box-shadow: 0 0 1px #6366f1;
      }

      input:checked + .slider:before {
        -webkit-transform: translateX(20px);
        -ms-transform: translateX(20px);
        transform: translateX(20px);
      }

      .slider.round {
        border-radius: 34px;
      }

      .slider.round:before {
        border-radius: 50%;
      }
    </style>

    <script>
      const { createApp, ref, onMounted, watch } = Vue;

      createApp({
        setup() {
          const loading = ref(true);
          const darkMode = ref(
            localStorage.getItem("darkMode") !== null
              ? localStorage.getItem("darkMode") === "true"
              : true
          );
          const settings = ref({
            camera_source: "ESP32-CAM",
            gesture_detection_enabled: true,
            show_landmarks: true,
            detect_all_leds: true,
            detect_led1: true,
            detect_led2: true,
            detect_led3: true,
            detect_motor: false,
            esp32_cam_url: "http://10.168.182.148:81/stream",
            esp8266_ip: "192.168.1.15",
          });
          const cameras = ref({});
          const deviceStatus = ref({});
          const motorValues = ref({});
          const videoFeedUrl = ref("/video_feed");
          let socket = null;
          const esp32TestStatus = ref({
            testing: false,
            success: false,
            message: "",
          });
          const esp8266TestStatus = ref({
            testing: false,
            success: false,
            message: "",
          });
          const deviceIcons = {
            led1: "lightbulb",
            led2: "lightbulb",
            motor: "speed",
          };

          const deviceDisplayNames = {
            led1: "Red LED",
            led2: "Green LED",
            motor: "Motor & Buzzer",
          };

          // Get icon for a device
          const getDeviceIcon = (device) => {
            return deviceIcons[device] || "device_unknown";
          };

          // Get display name for a device
          const getDeviceDisplayName = (device) => {
            return deviceDisplayNames[device] || device;
          };

          // Initialize the application
          const initApp = async () => {
            try {
              const [settingsData, camerasData, deviceData] = await Promise.all(
                [fetchSettings(), fetchCameras(), fetchDeviceStatus()]
              );

              settings.value = settingsData;
              cameras.value = camerasData;
              deviceStatus.value = deviceData;

              updateVideoFeedUrl();

              setupSocket();

              loading.value = false;
            } catch (error) {
              console.error("Error initializing app:", error);
            }
          };

          // Add timestamp to video feed URL to prevent caching
          const updateVideoFeedUrl = () => {
            const timestamp = new Date().getTime();
            videoFeedUrl.value = `/video_feed?t=${timestamp}`;
          };

          const testESP32Cam = async () => {
            esp32TestStatus.value = {
              testing: true,
              success: false,
              message: "",
            };
            try {
              const response = await axios.post("/api/test/connection", {
                type: "esp32cam",
                url: settings.value.esp32_cam_url,
              });
              esp32TestStatus.value = {
                testing: false,
                success: response.data.success,
                message: response.data.message,
              };
            } catch (error) {
              esp32TestStatus.value = {
                testing: false,
                success: false,
                message: "Test failed: " + error.message,
              };
            }
          };

          const testESP8266 = async () => {
            esp8266TestStatus.value = {
              testing: true,
              success: false,
              message: "",
            };
            try {
              const response = await axios.post("/api/test/connection", {
                type: "esp8266",
                ip: settings.value.esp8266_ip,
              });
              esp8266TestStatus.value = {
                testing: false,
                success: response.data.success,
                message: response.data.message,
              };
            } catch (error) {
              esp8266TestStatus.value = {
                testing: false,
                success: false,
                message: "Test failed: " + error.message,
              };
            }
          };

          const backendRestarting = ref(false);

          // Save network settings and restart backend
          const saveNetworkSettings = async () => {
            try {
              backendRestarting.value = true;
              loading.value = true;

              const response = await axios.post("/api/network/settings", {
                esp32_cam_url: settings.value.esp32_cam_url,
                esp8266_ip: settings.value.esp8266_ip,
              });

              if (response.data.restarting) {
                console.log("[FRONTEND] Backend restarting...");

                if (socket) {
                  socket.disconnect();
                }

                await waitForBackendRestart();
              } else {
                alert("Network settings saved successfully!");
                backendRestarting.value = false;
                loading.value = false;
              }
            } catch (error) {
              console.error("Error saving network settings:", error);
              backendRestarting.value = false;
              loading.value = false;
              alert("Failed to save network settings. Please try again.");
            }
          };

          // Wait for backend to restart and reconnect
          const waitForBackendRestart = async () => {
            let attempts = 0;
            const maxAttempts = 30;

            const checkBackend = async () => {
              try {
                await axios.get("/api/settings");
                console.log("[FRONTEND] Backend is back online!");

                await initApp();
                backendRestarting.value = false;
                loading.value = false;

                alert(
                  "Network settings updated successfully! Backend restarted."
                );
              } catch (error) {
                attempts++;
                if (attempts < maxAttempts) {
                  console.log(
                    `[FRONTEND] Waiting for backend... (${attempts}/${maxAttempts})`
                  );
                  setTimeout(checkBackend, 1000);
                } else {
                  console.error("[FRONTEND] Backend restart timeout!");
                  backendRestarting.value = false;
                  loading.value = false;
                  alert(
                    "Backend restart timeout. Please refresh the page manually."
                  );
                }
              }
            };

            setTimeout(checkBackend, 2000);
          };

          const setupSocket = () => {
            socket = io();

            socket.on("connect", () => {
              console.log("Connected to server");
            });

            socket.on("device_status", (status) => {
              deviceStatus.value = status;
            });

            socket.on("disconnect", () => {
              console.log("Disconnected from server");
            });
          };

          const fetchSettings = async () => {
            try {
              const response = await axios.get("/api/settings");
              return response.data;
            } catch (error) {
              console.error("Error fetching settings:", error);
              return settings.value;
            }
          };

          const settingsChangeTimeout = ref(null);

          const updateSettings = async () => {
            if (settingsChangeTimeout.value) {
              clearTimeout(settingsChangeTimeout.value);
            }

            settingsChangeTimeout.value = setTimeout(async () => {
              try {
                console.log("Applying settings changes...");
                await axios.post("/api/settings", settings.value);
                setTimeout(() => {
                  updateVideoFeedUrl();
                }, 1000);
              } catch (error) {
                console.error("Error updating settings:", error);
              }
            }, 500);
          };

          // Save settings
          const saveSettings = async () => {
            try {
              await axios.post("/api/settings", settings.value);
              alert("Settings saved successfully!");
              updateVideoFeedUrl();
            } catch (error) {
              console.error("Error saving settings:", error);
              alert("Failed to save settings. Please try again.");
            }
          };

          // Fetch cameras from API
          const fetchCameras = async () => {
            try {
              const response = await axios.get("/api/cameras");
              return response.data;
            } catch (error) {
              console.error("Error fetching cameras:", error);
              return {};
            }
          };

          // Fetch device status from API
          const fetchDeviceStatus = async () => {
            try {
              const response = await axios.get("/api/device/status");
              return response.data;
            } catch (error) {
              console.error("Error fetching device status:", error);
              return {};
            }
          };

          // Control a device
          const controlDevice = async (device, action) => {
            try {
              await axios.post(`/api/device/${device}/${action}`);
            } catch (error) {
              console.error(`Error controlling ${device}:`, error);
              alert(`Failed to control ${device}. Please try again.`);
            }
          };

          // Toggle device state
          const toggleDevice = async (device, isOn) => {
            await controlDevice(device, isOn ? "on" : "off");
          };

          // Toggle dark mode
          const toggleDarkMode = () => {
            darkMode.value = !darkMode.value;
            localStorage.setItem("darkMode", darkMode.value);
            document.body.style.backgroundColor = darkMode.value
              ? "#111827"
              : "#f9fafb";
          };

          // Watch for dark mode changes
          watch(darkMode, (newVal) => {
            document.body.style.backgroundColor = newVal
              ? "#111827"
              : "#f9fafb";
          });

          // Initialize app on mount
          onMounted(() => {
            initApp();

            document.body.style.backgroundColor = darkMode.value
              ? "#111827"
              : "#f9fafb";

            if (localStorage.getItem("darkMode") === null) {
              localStorage.setItem("darkMode", "true");
            }

            return () => {
              if (socket) {
                socket.disconnect();
              }
            };
          });

          return {
            loading,
            darkMode,
            settings,
            cameras,
            deviceStatus,
            videoFeedUrl,
            backendRestarting,
            getDeviceIcon,
            getDeviceDisplayName,
            updateSettings,
            saveSettings,
            controlDevice,
            toggleDevice,
            toggleDarkMode,
            esp32TestStatus,
            esp8266TestStatus,
            testESP32Cam,
            testESP8266,
            saveNetworkSettings,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
